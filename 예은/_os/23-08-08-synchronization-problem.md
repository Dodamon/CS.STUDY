# Sunchronization Problem

OS에서 동기회 문제란 서로 다른 thread가 메모리 영역을 공유하면서 발생한다. 여러 thread가 동일한 자원에 동시에 접근하게 되면 이상한 값을 읽거나 수정하면서 문제가 발생하는 것이다. 이런 문제를 해결하기 위해서는 임계영역을 설정하고 Semaphore와 Mutex기법을 활용해 해결할 수 있다.

프로그래밍을 할 때도 이런 동기화 문제를 해결해야 하는 순간이 생기는 데 이런 이론을 기반으로 응용한 방법을 사용한다

## WHY?

### **Critical section**

임계 구역은 **다수의 프로세스가 데이터를 공유하며 실행되는 상황에서 각 프로세스가 공유 자원에 접근하는 코드 블록**을 의미한다. **다수의 프로세스가 동시에 공유 자원에 접근하여 사용하면 문제**가 생기게된다.

즉, 한 process/thread가 자신의 임계구역에서 수행하는 동안에는 다른 process/thread들은 그들의 임계구역에 들어갈 수 없어야 한다. 임계영역 내의 코드는 원자적으로(atomically) 실행이 되어야 한다.

임계영역의 코드가 원자적으로 실행되기 위해서는 process/thread가 코드에 진입할때 (entry section)에서 진입 허가를 받고, 코드에서 나갈때(exit section)에서 퇴출하게 되면서 원자적으로의 실행을 보호할수 있다.

### Atomic Operation

CPU는 atomic operation을 연산하기 때문에 count++이라는 연산에 3번의 연산이 발생하게 된다.

1. count 값을 가져온다
2. count 값을 1 증가 시킨다.
3. count 값을 저장한다.

만약에 3개의 연산이 한 thread에서 발생하지 않고 thread1이 3연산을 하기전 thread2가 count값을 가져온다면 서로 count값이 꼬이게 될것이다. 이처럼 어떤 프로세스가 마지막으로 데이터에 접근했는지에 따라 데이터의 상태가 달라지는 것을 **“경쟁상태”**라고 한다.

### **Race Condition**

여러 프로세스들이 공유 자원에 동시에 접근하려고 하는 상황을 경쟁 상태라고 한다. 어떤 프로세스가 마지막으로 데이터에 접근했는지에 따라 데이터의 상태가 달라지게 된다. 즉, 데이터의 일관성을 보장할 수 없어진다.

경쟁 상황으로부터 보호하기 위해, 우리는 한 순간에 하나의 process/thread만 해당 자원에 접근하고 조작할 수 있도록 보장해야 한다. 다시 말해서 process/thread들이 **동기화(Synchronized)**되어야 한다.

## HOW? (동기화 방법)

### Semaphore

Semaphore는 깃발이라는 뜻으로 기찻길에서 깃발표식으로 파란색이 걸려있으면 지나가고 빨간색은 지나가지 못하는 것을 보여주는 용도로 사용했다. 이를 사용해 동기화할 수 있다.

S개의 thread만이 공유 자원에 접근할 수 있도록 제어하는 동기화 기법이다. 사용할 수 있는 리소스의 수를 S로 초기화 하고 thread가 이 자원을 사용하게 된다면 S—을 통해 세마포 값을 감소시키고 리소스를 다 사용한 뒤 방출 할 때는 S++를 통해 세마포 값을 증가 시켜준다. S값이 0이라면 모든 자원이 사용 중 임을 뜻한다. 이후 자원을 사용하려는 프로세스는 세마포 값이 0보다 커질 때까지 block 하게 된다.

### Mutex

Mutex는 상호 배제(**_Mutual Exclusion_**)의 줄임말 이다. 파이썬의 GIL이 이 뮤텍스에 속한다. **뮤텍스는 이진(Binary) 세마포어**이기도하다. 한번의 1개의 thread만이 공유 자원에 접근 할 수 있도록 하며 한 thread가 자원을 사용 중이라면 lock을 걸고 이후 리소스를 방출할 때 unlock을 하면서 다른 thread가 접근 할 수 있도록 한다.

**둘의 가장 큰 차이점은 동기화 대상의 갯수이다. 세마포어는 *뮤텍스*가 될 수 있지만, *뮤텍스*는 세마포어가 될 수 없다.**
